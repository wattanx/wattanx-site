---
import { readFileSync, writeFileSync } from 'node:fs'
import { perseMeta } from '~/utils/metaParser'

type Props = {
  url: string;
};

type OGPJson = {
  [key: string]: {
    title: string;
    description: string;
    image: string;
  };
};

const { url } = Astro.props;

const generatedFilePath = new URL(
  "../../cache/ogp.json",
  import.meta.url
);

const cache: OGPJson = JSON.parse(readFileSync(generatedFilePath, "utf8"));

let title: string = "";
let description: string = "";
let image: string = "";

if (cache[url]) {
  title = cache[url].title;
  description = cache[url].description;
  image = cache[url].image;
} else {
  const html = await fetch(url).then((res) => res.text());
  const parsed = perseMeta(html);

  title = parsed.title;
  description = parsed.description;
  image = parsed.ogImage;

  if (image && !image.startsWith("http")) {
    image = `${new URL(url).origin}/${image}`;
  }

  if (import.meta.env.PROD) {
    const ogp = JSON.parse(readFileSync(generatedFilePath, "utf8"));

    writeFileSync(
      generatedFilePath,
      JSON.stringify(
        {
          ...ogp,
          [url]: {
            title,
            description,
            image,
          },
        },
        null,
        2
      )
    );
  }
}
---

<a href={url} target="_blank" class="flex rounded-lg border border-gray-600 gap-4 justify-between h-32">
  <div class="flex flex-col gap-2 flex-1 py-4 pl-4">
    <p class="font-semibold !my-0">
      {title}
    </p>
    <span class="text-sm text-gray-500"
      >{
        description && description.length > 100
          ? `${description?.slice(0, 100)}...`
          : description
      }</span
    >
  </div>
  {
    image && (
      <div class="max-w-[230px]">
        <img
          src={image}
          class="object-cover w-32 sm:w-full sm:h-full rounded-r-lg"
          alt="title"
          decoding="async"
        />
      </div>
    )
  }
</a>